---
layout: post
title: "资源赛马——从计划经济到市场经济的初试"
description: ""
category: "算法"
tags: [推荐,个性化,排序]
summary:
---


## 引言

个性化技术对于电商移动应用的作用早已不言而喻，已经成为提升用户体验、提高点击率和转化率的重要手段。打开淘宝、天猫、京东等APP，善于观察的朋友就会注意到，其中的许多栏位（亦称“资源位”）已经应用了个性化方案，即在同样的栏位，不同的用户看到的商品、图片乃至文案都不尽相同。这些被展示的内容，往往是依据用户的兴趣偏好计算得到——它可能是你近期反复看过但一直犹豫还未购买的商品，可能是你长期购买的品牌，可能是经常逛的店铺，甚至是从未看过的东西但却勾起了你的强烈好奇心......

在考拉APP的主要栏位，也早已应用了个性化推荐技术，首页的商品瀑布流、商品详情页的相似推荐、分类tab页的常用分类、购物车页的猜你喜欢、每日上新、好物推荐......等等，推荐的场景多而繁杂。然而，首页头部栏位的个性化覆盖度很低，占首页首屏的轮播位和面积占比最大的精选活动位都没有引入个性化方案。首页虽然有商品瀑布流作为个性化的主战场，但是由于位置非常靠后，每日获得的曝光uv也只占首页uv的1/20，个性化的能力并没有得到充分的发挥。如果能对这两块资源位引入个性化，那么将更好地利用宝贵的流量，提升用户体验的同时获得转化率和GMV的增长。

在这之前，首页资源的投放主要是“计划经济”时代，考拉的各个BU（母婴、美容彩妆、轻奢、营养保健、个人洗护、工厂店等等）获得资源位的分配和排期，在排期日之前运营同学制作好活动素材上传，排期日当天素材就被展示在相应的资源位，为自己的BU引流。位置的分配和排期的方式不会频繁变更，分配的方式则由运营管理者制定，每个BU都会获得资源的分配，头部BU（母婴、美妆）可能获得的资源相对多些，小BU获得的资源就相对少些。由于考拉以自营为主，这样的资源分配方式占了主导地位。优点是分配方式公开、透明、简单，缺点则是缺乏灵活性，对流量的利用和适配相对粗暴。

在这样的背景下，“资源赛马”项目应运而生，其目的在于为APP首页头部素材资源位进行个性化赋能，同时过滤出优质素材、提高运营提报素材的活跃度，提升首页资源位所展示素材的质量，提升流量价值。

## 资源赛马

所谓“资源赛马”，在项目中的含义是：允许各个BU的运营每天都可提报活动素材，所有素材在一个固定时段内获得均分的流量，脱颖而出的优质素材将在当日剩下的时段获得资源位的使用权，而被淘汰的素材当日将不再获得流量。这种想法非常自然，就像赛马一样，我们提供一个公平的竞争环境，参赛者参与角逐，跑得快的马将获得奖励。其中各个元素的对应关系可以描述如下：

- 公平的竞争环境——首页资源位、相同时段的流量均分
- 参赛者——各BU提报的素材
- “跑得多快”的评价方式——根据比赛时段内素材的点击率、引导转化率、曝光uv价值等设计的综合评价指标
- 奖励——更多的流量资源

具体地，流量的分配以天为单位，分成两个阶段：赛马阶段，当日00:00-09:50，所有素材参与赛马，获得均分流量；个性化阶段，当日10:00-23:59，在赛马阶段胜出的素材获取个性化流量。在个性化阶段，对于一个到达的用户请求，优先为其展示偏好的BU的素材。

![点击率](https://raw.githubusercontent.com/mioopoi/Images/master/2019-01-02-resource-optimization/resource-racing-flow.png)

有同学可能会疑问，直接进入个性化阶段不就好了，为什么还要有赛马阶段？赛马的一方面目的是过滤出较少的优质素材，相当于召回过程（但是又不同于一般意义上的推荐召回，因为这个召回并不是针对某个特定用户）；另一方面是为了给各个BU提供流量，由于只要提报素材就能进入赛马阶段，即便不胜出，也能获得一段时间的流量，这其实对平时获得流量较小的BU就有刺激作用，会提高运营提报素材的积极性，从这个角度而言，赛马阶段的存在是必要的——事实上，也正是由于有赛马阶段的存在，这个项目才得以获得各BU的认可，才得以推动下去。

在实现过程中，我们会遇到一些重要的问题须要解决：

1. 赛马阶段，如何安排赛马以尽可能保证赛马环境的公平性？
2. 赛马的评价方式如何设计？赛马结果如何获得？
3. 个性化阶段，个性化的依据是什么？个性化展示的具体方式又是怎样的？

下面，将对这几个问题一一说明我们的设计方案。

### 流量预估

赛马环境的一致性和公平性是策略成功的重要前提，因此，在哪个位置上进行赛马，以及安排多少素材同时参与赛马，就是必须要回答的问题，而这就离不开流量预估。在同一个帧位上安排赛马的素材过多，每个素材获得的流量很少，从而导致评价指标如点击率、转化率的抖动；反之，安排赛马的素材过少，虽然每个素材能获得足够的流量，但会降低赛马效率，也是一种流量浪费。对一个资源位流量的合理预估，将能使得赛马的布置更科学、赛马结果更可信。

经过与各BU运营同学的沟通，我们定下的业务场景大概是这样：所有素材由运营提前一个工作日准备与提报，赛马尽量在流量最大的帧位进行，比如首页A区轮播位第一帧，或者首页B区强推位的第一帧，流量大的帧位可以较好地满足多素材赛马，流量的预估也容易做得准确。每天，流量预估算法离线预估下一天赛马资源位在赛马阶段的流量水平（即uv），给出该资源位适合同时进行赛马的素材数量的最大值，系统据此安排参赛的素材。对于提报素材较多无法安排进一个帧位赛马的情况，剩余的素材统一安排在流量次大的帧位，以此类推。

我们面临的流量预估问题可以描述如下：预测一个资源位第二天00:00-10:00的uv。这是一个典型的时间序列预测问题，可以采用经典的时间序列预测方法或者机器学习模型来做。但是经过调研，我们还是决定采用规则做预测，原因主要有以下几点：其一，历史数据的积累不够丰富，预测的粒度可以认为是天，考拉APP2015年上线，一个资源位积累的数据量也就几千，不至于采用较为复杂的模型；其二，不考虑大促活动，考拉APP每日的流量水平相对稳定，预测的难度并不大；其三，对于异常事件（如大促）的预测其实很难，因为我们拿不到市场部有多少预算，而这显然是一个强特征，如果获取不到这个数据，即便采用机器学习模型也无济于事。

通过对首页各个资源位历史流量数据的观察、分析与总结，我们整理出了如下的流量预测规则：

- 平销日预测：分工作日、双休日和法定节假日，工作日用过去若干天当前小时的均值，双休日用过去若干双休日当前小时的均值，法定节假日以此类推。实际线上采取的计算策略是：`uv(day, position, start_time, duration) = avg(uv(过去两个月的普通平销日 且 同一星期, position, start_time, duration))`
- 大促预测：分S级大促和A级大促，S级大促用过去若干S级大促当前小时的均值（618/双11/黑五/双12直接用去年同期的数据作为预测值）， A级大促用过去若干A级大促当前小时的均值。另外，对于下一天是大促第一天的平销日或者前一天是大促最后一天的平销日，对不同时段采取乘系数处理。


实现上，由于规则简单，用SQL即可较好地描述它们。而且，考虑到可扩展性和计算的简便，我们设计了轻度汇总表和时段配置维度表，以应对后续可能的需求变更（如赛马时段的变更）和赛马资源位的增加。轻度汇总表的结构（脱敏）如下：

```sql
CREATE TABLE IF NOT EXISTS some_db.dwd_kl_flw_zp_behavior_1d
(
  deviceudid string comment '设备id',
  account_id string comment '账号',
  holiday_type int comment '活动类型',
  promotion_type int comment '活动类型',
  period string comment '日志所属时段',
  action_type string comment '行为类型,exposure、click、ipv',
  zone string comment '区域名称',
  position string comment '位置',
  page_type string comment '页面类型',
  page_id string comment '页面ID',
  pv int comment '次数'
) 
COMMENT '资源赛马-离线分析细节表，用于流量预估'
PARTITIONED BY (day STRING)
STORED AS PARQUET
TBLPROPERTIES('parquet.compression'='SNAPPY');
```

时段配置维度表（脱敏）结构：

```sql
CREATE TABLE IF NOT EXISTS some_db.dim_kl_common_duration_conf
(
  start_time string COMMENT '开始时刻, 都是半点, 比如00:00, 06:30'
  ,num_slot int COMMENT '从开始时刻往后的时隙数 (时隙是统计时间的最小单元)'
  ,mark_slot_size int COMMENT '时隙长度的标识, 值为1或2, 1表示30分钟, 2表示60分钟'
)
COMMENT '资源赛马-流量预估-统计时段配置表'
STORED AS PARQUET
```
用于存储流量预估结果的结果表：

```sql
CREATE TABLE IF NOT EXISTS some_db.resource_diagnosis_race_flw_prediction (
  page_type string COMMENT '页面类型'
  ,page_id string COMMENT '页面id'
  ,location_id bigint COMMENT '位置id(与zone对应)'
  ,frame_id bigint COMMENT 'frame_id(一个资源位的唯一标识)'
  ,zone string COMMENT '区域(与location_id对应,相当于location_name)'
  ,position string COMMENT '模块内位置'
  ,start_time string COMMENT '开始时刻'
  ,duration_time string COMMENT '持续时长'
  ,predicted_exposure_uv int COMMENT '预测的累计曝光人数'
)
COMMENT '资源赛马-流量预估-资源位分小时累计uv预测表'
PARTITIONED BY (day string)
STORED AS PARQUET
```

数据的产出结果都存储在Hive表里，为了给线上服务使用，因此还必须有数据同步的环节。目前采用的方式是通过定时调度脚本将Hive表里的数据同步到线上Redis中。此外，我们制作了可视化的图表，用以监控流量预测的误差水平，下图展示了某7日流量预估值与实际值的情况。

![点击率](https://raw.githubusercontent.com/mioopoi/Images/master/2019-01-02-resource-optimization/resource-racing-traffic-prediction.png)

有了资源位的流量预估值，资源投放系统就能为赛马资源位分配合适的参赛素材，从而保障赛马的顺利进行。

### 评价方式设计

对于物理世界的赛马而言，评价马跑得快不快的标准很简单——到达终点的时间长短，时间越短，表示马跑得越快。那么在我们的资源赛马项目中，如何评价一个素材“跑得有多快”？前面说过，是根据比赛时段内素材的点击率、引导转化率、曝光uv价值等设计的综合评价指标。然而具体如何设计？如果直接取其中某个指标，或者对它们加权平均，是否可行？客观上来说，这么设计是最公平的，但是在与各方BU协调的过程中，还是遇到了众口难调的问题，因为如果采用该方案，势必对头部BU是有利的，原因在于考拉的整体用户画像就是以对母婴、美妆商品有较大偏好的女性群体为主。这样一来，即便弱势BU能通过赛马阶段获取流量，也很难胜出，还不一定比原来的固定排期好多少，因为固定排期至少能获得一整天的流量。

最终我们定的方案是“参赛者自己与自己比”，这个方案得到了所有BU的认同。具体地，是用*素材在赛马阶段的指标数值*与*该BU在该资源位历史90天平销期同一指标的平均值*的**比值**作为赛马的评价指标，如果有多个指标，则取这些比值的加权平均，权重由各BU协商给出。具体实现细节上，会加上平滑处理等手段。这意味着什么呢？就相当于，虽然大家都在比赛，但比的不是谁先到终点，而是相比自己历史平均水平提高了多少——只要超越了自己，就能大概率胜出。这样一来，弱势BU也仿佛看到了希望，踌躇满志。

### 个性化展示

个性化展示阶段，胜出的素材将会获得个性化的流量，即如果一个用户偏好某个BU，那么他将能在最醒目的位置看到该BU投放的素材。于是我们要解决的两个核心问题是：

1. 用户对BU的偏好如何计算？
2. 当用户对多个开启个性化的资源位发起访问请求时，如何为各个位置分配素材？

第一个问题通过对离线用户行为数据的挖掘得到，基本思路是通过分析用户在不同BU/类目下查看、点击、加购、购买等行为的分布情况给出用户对不同BU的偏好权重。然后通过定时任务将hive数据同步到Redis供线上使用。

第二个问题类似于排序问题，基本思路是以用户对素材所属BU的偏好作为分数进行排序，优先将分数高的素材安排在流量较大的位置。实际实现中，考虑到开启个性化展示的资源位有限（非瀑布流的形式）、用户的刷新动作以及能让低偏好的素材依然有机会展示，我们保存了对用户上一次展示的排布结果，在用户刷新页面或者下一次访问时，滚动更新展示素材，具体形式见下图。

![点击率](https://raw.githubusercontent.com/mioopoi/Images/master/2019-01-02-resource-optimization/resource-racing-personalization.jpg)

## 线上应用及效果评估

**线上产品形态**。主要在于首页活动资源位（A区轮播、B区精选活动）针对不同用户的个性化展示，不同用户访问这些位置时，将能在显眼的头部位看到他们所偏好的类目的活动素材。比如，一位成为妈妈不久的女性将在第一个轮播位看到母婴类的活动素材，而一个喜欢运动的小伙将看到运动户外类的素材。产品没有前端形态的增加或者修改，对用户的影响比较平滑，甚至用户不容易意识到这种变化，主要工作体现在服务端资源投放的赛马过程和个性化计算。

**上线后的效果**。A/B测试的实验组是资源赛马项目的投放方案，对照组是运营人工投放方案。项目上线后累计进行了21场投放实验，赛马资源位流量约占首页流量的7.6%，赛马资源位曝光uv价值较历史90天均值提升**21.6%**，AB相比对照组曝光uv价值提升**32.4%**，项目的成效显著。

## 结语

本文主要概述了资源赛马项目在首页资源位优化中的应用，阐述了资源赛马的提出背景、流量预估的目的和方法、对素材效果评价指标的设计、个性化展示阶段的核心问题的解决思路，以及上线后的效果。当然，由于开发时间的关系，项目本身在技术层面上还有优化的空间，比如我们目前的偏好计算都是离线计算用户长期偏好的，如果引入用户对类目的实时偏好是不是更好？目前没有采用模型，而是直接将用户对BU的偏好作为素材的分数，如果引入更多的信息如用户画像、素材画像来进行点击率的预估会不会更好？这些都可以作为后续迭代的方向。

回头看，其中感触最深的，还是方案的诞生过程——死理性派固然精确简单，但常常并不是做事的正确姿势，不断与各方沟通、协调乃至妥协，把项目一点一点地推进下去，才是项目落地的合理姿势。如果能看到上线后有了正面的效果，那更是令人快乐。